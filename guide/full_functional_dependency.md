# 完全関数従属性について

→ [2_normalize - 第２正規形 - 完全関数従属性とは？](../2_normalize/2_nf.md#完全関数従属とは)

## 完全関数従属性とは？

- 関数従属性 X → Y において、X の全ての真部分集合 X’ について、X’ → Y が成立しないこと

## 完全関数従属を見つける例

- 関係スキーマ **伝票（伝票番号, 顧客番号, 顧客名, 商品番号, 商品名, 数量）**

- 候補キーを列挙する

  - {伝票番号, 商品番号}, {伝票番号, 商品名} の 2 つとする

- 非キー属性を列挙する

  - “顧客番号”, ”顧客名”, ”数量” の 3 つ

### 非キー属性 "数量" は完全関数従属性しているか？

- 「関数従属性 X → Y において、X の全ての真部分集合 X’ について、X’ → Y が成立しないこと」を検査してく

- 候補キーを X に置き、非キー属性を Y に置くと、次のような関数従属性となる

  - {伝票番号, 商品番号} → ”数量”

  - {伝票番号, 商品名} → ”数量”

- 「{伝票番号, 商品番号} → ”数量”」の検査をする

  - X の全ての真部分集合 X’ は何か？

    - {伝票番号}

    - {商品番号}

  - X’ → Y は成立するか？

    - {伝票番号} → {数量}：伝票番号から数量は決まらないので **成立しない**

    - {商品番号} → {数量}：商品番号から数量は決まらないので **成立しない**

    - X’ → Y は成立しない

  - 非キー属性 "数量" は完全関数従属しているか？

    - している

    - {伝票番号, 商品番号} → {数量} は、すべての真部分集合で関数従属性が成り立たないので、非キー属性 “数量” は候補キー {伝票番号, 商品番号} に完全関数従属していると言える

### 非キー属性 "顧客番号", "顧客名" は完全関数従属性しているか？

- 「関数従属性 X → Y において、X の全ての真部分集合 X’ について、X’ → Y が成立しないこと」を検査してく

- 候補キーを X に置き、非キー属性を Y に置くと、次のような関数従属性となる

  - {伝票番号, 商品番号} → {顧客番号, 顧客名}

  - {伝票番号, 商品名} → {顧客番号, 顧客名}

- 「{伝票番号, 商品番号} → {顧客番号, 顧客名}」の検査をする

  - X の全ての真部分集合 X’ は何か？

    - {伝票番号}

    - {商品番号}

  - X’ → Y は成立するか？

    - {伝票番号} → {顧客番号, 顧客名}：伝票番号と顧客番号は一意に対応している。かつ、顧客番号と顧客名も一意に対応しているので、 **成立する**

    - {商品番号} → {顧客番号, 顧客名}：商品番号から顧客番号は決まらないので **成立しない**

    - X’ → Y は完全には成立しない

  - 非キー属性 "顧客番号", "顧客名" は完全関数従属しているか？

    - 完全にはしていない

    - この関数従属性のことを部分関数従属性という

## 部分関数従属性があった場合どうなる？

- 第２正規形で排除する

## 部分関数従属性の排除はどうやってやる？

- 候補キーに対して部分関数従属となっている関数従属性を別の関係（リレーション）として分ける

- 具体的には、部分関数従属する候補キーの一部を新たな関係候補キー（主キー）とし、非キー属性をその関係に移動させる

  | A      | B        | C（B に従属） |
  | ------ | -------- | ------------- |
  | 主キー | 候補キー | 非キー属性    |

  👇

  | A      | B        |
  | ------ | -------- |
  | 主キー | 候補キー |

  | B      | C          |
  | ------ | ---------- |
  | 主キー | 非キー属性 |

## 伝票リレーションを用いた、部分関数従属性の排除の例

### おさらい

- 伝票スキーマは `伝票（伝票番号, 顧客番号, 顧客名, 商品番号, 商品名, 数量）`

- 部分関数従属は `{伝票番号} → {顧客番号, 顧客名}`

### 部分関数従属性を別関係（リレーション）へ移動させる

- `{伝票番号} → {顧客番号, 顧客名}` の "伝票番号" を主キーとし、非キー属性を "伝票番号" を主キーとした関係（リレーション）へ移動させる

- 次のような関係（リレーション）スキーマが出来上がる

  - `伝票明細（伝票番号, 商品番号, 商品名, 数量）`

  - `伝票（伝票番号, 顧客番号, 顧客名）`

- 第２正規形として表現するとこうなる

  - 伝票明細リレーション

    | 伝票番号 | 商品番号 | 商品名         | 数量 |
    | -------- | -------- | -------------- | ---- |
    | 1001     | 2001     | チョコレート   | 5    |
    | 1001     | 2002     | キャラメル     | 10   |
    | 1002     | 2001     | チョコレート   | 5    |
    | 1002     | 2003     | ドーナツ       | 20   |
    | 1002     | 2004     | シュークリーム | 5    |
    | 1003     | 2005     | プロテイン     | 30   |
    | 1004     | 2005     | プロテイン     | 30   |

  - 伝票リレーション

    | 伝票番号 | 顧客番号 | 顧客名     |
    | -------- | -------- | ---------- |
    | 1001     | 11       | ねこ商事   |
    | 1001     | 11       | ねこ商事   |
    | 1002     | 13       | うさぎ開発 |
    | 1002     | 13       | うさぎ開発 |
    | 1002     | 13       | うさぎ開発 |
    | 1003     | 29       | くま工業   |
    | 1004     | 29       | くま工業   |
